{{ define "main" }}
  {{ partial "page-header" . }}


  <section class="section-sm">
    <div class="container">
      <div class="row">
        <div class="md:col-10 lg:col-6 mx-auto">
          <form id="contact-form" action="https://formspree.io/f/meelpwkn" method="POST" novalidate>
            <div class="mb-6">
              <label for="name" class="form-label">
                {{ if eq site.Language.Lang "pt-br" }}Nome Completo{{ else }}Full Name{{ end }} <span class="text-red-500">*</span>
              </label>
              <input
                id="name"
                name="name"
                class="form-input"
                placeholder="{{ if eq site.Language.Lang "pt-br" }}Seu nome{{ else }}John Doe{{ end }}"
                type="text"
                required
                minlength="3" />
              <p class="text-red-500 text-sm mt-1 hidden" id="name-error">
                {{ if eq site.Language.Lang "pt-br" }}Por favor, insira seu nome (mínimo 3 caracteres).{{ else }}Please enter your name (minimum 3 characters).{{ end }}
              </p>
            </div>
            <div class="mb-6">
              <label for="email" class="form-label">
                {{ if eq site.Language.Lang "pt-br" }}E-mail{{ else }}Working Mail{{ end }} <span class="text-red-500">*</span>
              </label>
              <input
                id="email"
                name="email"
                class="form-input"
                placeholder="{{ if eq site.Language.Lang "pt-br" }}seu@email.com{{ else }}john.doe@email.com{{ end }}"
                type="email"
                required />
              <p class="text-red-500 text-sm mt-1 hidden" id="email-error">
                {{ if eq site.Language.Lang "pt-br" }}Por favor, insira um e-mail válido.{{ else }}Please enter a valid email address.{{ end }}
              </p>
            </div>
            <div class="mb-6">
              <label for="message" class="form-label">
                {{ if eq site.Language.Lang "pt-br" }}Mensagem{{ else }}Anything else?{{ end }} <span class="text-red-500">*</span>
              </label>
              <textarea
                id="message"
                name="message"
                class="form-input"
                placeholder="{{ if eq site.Language.Lang "pt-br" }}Escreva sua mensagem aqui...{{ else }}Message goes here...{{ end }}"
                rows="8"
                required
                minlength="10"></textarea>
              <p class="text-red-500 text-sm mt-1 hidden" id="message-error">
                {{ if eq site.Language.Lang "pt-br" }}Por favor, escreva sua mensagem (mínimo 10 caracteres).{{ else }}Please write your message (minimum 10 characters).{{ end }}
              </p>
            </div>
            <div class="mb-6">
              <div id="hcaptcha-container"></div>
              <p class="text-red-500 text-sm mt-1 hidden" id="captcha-error">
                {{ if eq site.Language.Lang "pt-br" }}Por favor, complete a verificação de segurança.{{ else }}Please complete the security verification.{{ end }}
              </p>
            </div>
            <button type="submit" id="submit-btn" class="btn btn-primary">{{ if eq site.Language.Lang "pt-br" }}Enviar{{ else }}Submit{{ end }}</button>
            <p class="text-green-500 text-sm mt-3 hidden" id="success-msg">
              {{ if eq site.Language.Lang "pt-br" }}Mensagem enviada com sucesso! Entraremos em contato em breve.{{ else }}Message sent successfully! We'll get back to you soon.{{ end }}
            </p>
            <p class="text-red-500 text-sm mt-3 hidden" id="error-msg">
              {{ if eq site.Language.Lang "pt-br" }}Erro ao enviar mensagem. Por favor, tente novamente.{{ else }}Error sending message. Please try again.{{ end }}
            </p>
          </form>
        </div>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- hCaptcha: renderização explícita com suporte a tema dark/light ---
      var HCAPTCHA_SITEKEY = '6b8a2a0c-1652-4b8c-b7e6-527c799e060a';
      var hcaptchaContainer = document.getElementById('hcaptcha-container');
      var hcaptchaWidgetId = null;

      function getCurrentTheme() {
        return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      }

      function renderHcaptcha() {
        if (hcaptchaWidgetId !== null) {
          hcaptcha.reset(hcaptchaWidgetId);
          hcaptcha.remove(hcaptchaWidgetId);
          hcaptchaContainer.innerHTML = '';
        }
        hcaptchaWidgetId = hcaptcha.render(hcaptchaContainer, {
          sitekey: HCAPTCHA_SITEKEY,
          theme: getCurrentTheme(),
        });
      }

      function waitForHcaptcha() {
        if (typeof hcaptcha !== 'undefined') {
          renderHcaptcha();
        } else {
          setTimeout(waitForHcaptcha, 100);
        }
      }
      waitForHcaptcha();

      // Observa mudanças de tema (classe 'dark' no <html>) e re-renderiza o hCaptcha
      new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class' && typeof hcaptcha !== 'undefined') {
            renderHcaptcha();
          }
        });
      }).observe(document.documentElement, { attributes: true });

      // --- Formulário de contato ---
      const form = document.getElementById('contact-form');
      const nameInput = document.getElementById('name');
      const emailInput = document.getElementById('email');
      const messageInput = document.getElementById('message');
      const nameError = document.getElementById('name-error');
      const emailError = document.getElementById('email-error');
      const messageError = document.getElementById('message-error');
      const successMsg = document.getElementById('success-msg');
      const errorMsg = document.getElementById('error-msg');
      const captchaError = document.getElementById('captcha-error');
      const submitBtn = document.getElementById('submit-btn');

      function validateField(input, errorEl, validationFn) {
        if (!validationFn(input.value.trim())) {
          errorEl.classList.remove('hidden');
          input.classList.add('border-red-500');
          return false;
        }
        errorEl.classList.add('hidden');
        input.classList.remove('border-red-500');
        return true;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      nameInput.addEventListener('blur', function() {
        validateField(nameInput, nameError, v => v.length >= 3);
      });
      emailInput.addEventListener('blur', function() {
        validateField(emailInput, emailError, v => emailRegex.test(v));
      });
      messageInput.addEventListener('blur', function() {
        validateField(messageInput, messageError, v => v.length >= 10);
      });

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const isNameValid = validateField(nameInput, nameError, v => v.length >= 3);
        const isEmailValid = validateField(emailInput, emailError, v => emailRegex.test(v));
        const isMessageValid = validateField(messageInput, messageError, v => v.length >= 10);

        // Validar hCaptcha
        const hcaptchaResponse = document.querySelector('[name="h-captcha-response"]');
        const isCaptchaValid = hcaptchaResponse && hcaptchaResponse.value !== '';
        if (!isCaptchaValid) {
          captchaError.classList.remove('hidden');
        } else {
          captchaError.classList.add('hidden');
        }

        if (isNameValid && isEmailValid && isMessageValid && isCaptchaValid) {
          submitBtn.disabled = true;
          successMsg.classList.add('hidden');
          errorMsg.classList.add('hidden');
          submitBtn.textContent = '{{ if eq site.Language.Lang "pt-br" }}Enviando...{{ else }}Sending...{{ end }}';

          const formData = new FormData(form);

          fetch(form.action, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
            },
            body: formData,
          })
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Erro HTTP: ' + response.status);
            }
            return response.json();
          })
          .then(function(data) {
            if (data.ok) {
              successMsg.classList.remove('hidden');
              errorMsg.classList.add('hidden');
              form.reset();
              if (hcaptchaWidgetId !== null) hcaptcha.reset(hcaptchaWidgetId);
            } else {
              throw new Error('Formspree retornou erro');
            }
            submitBtn.textContent = '{{ if eq site.Language.Lang "pt-br" }}Enviar{{ else }}Submit{{ end }}';
            submitBtn.disabled = false;
          })
          .catch(function(err) {
            console.error('Erro no envio do formulário:', err);
            errorMsg.classList.remove('hidden');
            successMsg.classList.add('hidden');
            submitBtn.textContent = '{{ if eq site.Language.Lang "pt-br" }}Enviar{{ else }}Submit{{ end }}';
            submitBtn.disabled = false;
          });
        }
      });
    });
  </script>
  <script src="https://js.hcaptcha.com/1/api.js?render=explicit" async defer></script>

  <!-- google map -->
  {{ with site.Params.google_map }}
    {{ if .enable }}
      <div
        id="map"
        style="height: 400px;"
        data-latitude="{{ .map_latitude }}"
        data-longitude="{{ .map_longitude }}"
        data-marker="{{ .map_marker | relURL }}"
        data-marker-name="{{ site.Title }}"></div>
    {{ end }}
  {{ end }}

  {{ with site.Params.subscription }}
    {{ if .enable }}
      <!-- subscription form -->
      <form
        action="{{ .mailchimp_form_action | safeURL }}"
        method="post"
        id="mc-embedded-subscribe-form"
        novalidate="novalidate">
        <div class="input-group w-75 mx-auto mb-3">
          <input
            type="email"
            name="EMAIL"
            placeholder="Email"
            class="form-control required email mce_inline_error"
            id="mce-EMAIL"
            aria-required="true"
            autocomplete="off"
            required />
          <button
            class="input-group-text"
            name="subscribe"
            id="mc-embedded-subscribe">
            {{ .button_label }}
          </button>
        </div>
        <input
          type="hidden"
          name="EMAILTYPE"
          id="mce-EMAILTYPE-0"
          value="html" />
        <div style="position:absolute;left:-5000px" aria-hidden="true">
          <input type="text" name="{{ .name }}" tabindex="-1" />
        </div>
      </form>
      <div id="mce-responses" class="clear">
        <div
          class="response text-white"
          id="mce-error-response"
          style="display:none"></div>
        <div
          class="response text-white"
          id="mce-success-response"
          style="display:none"></div>
      </div>
      <script
        type="text/javascript"
        src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script>
      <!-- /subscription form -->
    {{ end }}
  {{ end }}

  {{ if site.Params.google_map.enable }}
    {{ $gmap:= resources.Get "plugins/maps/google-map.js" }}
    <script defer src="{{ $gmap.RelPermalink }}"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ site.Params.google_map.map_api_key }}&libraries=places"></script>
  {{ end }}

{{ end }}
